
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ChristopherMarais.github.io/ibbi/api/">
      
      
        <link rel="prev" href="../usage/">
      
      
        <link rel="next" href="../CONTRIBUTING/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>API Reference - IBBI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="IBBI Documentation" class="md-header__button md-logo" aria-label="IBBI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IBBI Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/ChristopherMarais/ibbi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ChristopherMarais/ibbi
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../usage/" class="md-tabs__link">
        
  
  
    
  
  Usage Guide

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  API Reference

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../CONTRIBUTING/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../LICENSE" class="md-tabs__link">
        
  
  
    
  
  License

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="IBBI Documentation" class="md-nav__button md-logo" aria-label="IBBI Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    IBBI Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ChristopherMarais/ibbi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    ChristopherMarais/ibbi
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Usage Guide
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ibbi" class="md-nav__link">
    <span class="md-ellipsis">
      ibbi
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ibbi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibbi.ModelType" class="md-nav__link">
    <span class="md-ellipsis">
      ModelType
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Evaluator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.classification" class="md-nav__link">
    <span class="md-ellipsis">
      classification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.embeddings" class="md-nav__link">
    <span class="md-ellipsis">
      embeddings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.object_detection" class="md-nav__link">
    <span class="md-ellipsis">
      object_detection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer" class="md-nav__link">
    <span class="md-ellipsis">
      Explainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer.with_lime" class="md-nav__link">
    <span class="md-ellipsis">
      with_lime
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer.with_shap" class="md-nav__link">
    <span class="md-ellipsis">
      with_shap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.clean_cache" class="md-nav__link">
    <span class="md-ellipsis">
      clean_cache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.create_model" class="md-nav__link">
    <span class="md-ellipsis">
      create_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.get_cache_dir" class="md-nav__link">
    <span class="md-ellipsis">
      get_cache_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.get_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      get_dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.get_shap_background_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      get_shap_background_dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.list_models" class="md-nav__link">
    <span class="md-ellipsis">
      list_models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.plot_lime_explanation" class="md-nav__link">
    <span class="md-ellipsis">
      plot_lime_explanation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.plot_shap_explanation" class="md-nav__link">
    <span class="md-ellipsis">
      plot_shap_explanation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../LICENSE" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    License
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ibbi" class="md-nav__link">
    <span class="md-ellipsis">
      ibbi
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ibbi">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibbi.ModelType" class="md-nav__link">
    <span class="md-ellipsis">
      ModelType
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Evaluator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.classification" class="md-nav__link">
    <span class="md-ellipsis">
      classification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.embeddings" class="md-nav__link">
    <span class="md-ellipsis">
      embeddings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Evaluator.object_detection" class="md-nav__link">
    <span class="md-ellipsis">
      object_detection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer" class="md-nav__link">
    <span class="md-ellipsis">
      Explainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Explainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer.with_lime" class="md-nav__link">
    <span class="md-ellipsis">
      with_lime
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.Explainer.with_shap" class="md-nav__link">
    <span class="md-ellipsis">
      with_shap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.clean_cache" class="md-nav__link">
    <span class="md-ellipsis">
      clean_cache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.create_model" class="md-nav__link">
    <span class="md-ellipsis">
      create_model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.get_cache_dir" class="md-nav__link">
    <span class="md-ellipsis">
      get_cache_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.get_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      get_dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.get_shap_background_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      get_shap_background_dataset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.list_models" class="md-nav__link">
    <span class="md-ellipsis">
      list_models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.plot_lime_explanation" class="md-nav__link">
    <span class="md-ellipsis">
      plot_lime_explanation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ibbi.plot_shap_explanation" class="md-nav__link">
    <span class="md-ellipsis">
      plot_shap_explanation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api-reference">API Reference</h1>
<p>This section provides an auto-generated API reference for the <code>ibbi</code> package.</p>


<div class="doc doc-object doc-module">



<h2 id="ibbi" class="doc doc-heading">
            <code>ibbi</code>


</h2>

    <div class="doc doc-contents first">

        <p>Main initialization file for the ibbi package.</p>
<p>This file serves as the primary entry point for the <code>ibbi</code> library. It exposes the most
important high-level functions and classes, making them directly accessible to the user
under the <code>ibbi</code> namespace. This includes the core model creation factory (<code>create_model</code>),
the main workflow classes (<code>Evaluator</code>, <code>Explainer</code>), and key utility functions for
accessing datasets and managing the cache.</p>
<p>The goal of this top-level <code>__init__.py</code> is to provide a clean and intuitive API,
simplifying the user experience by abstracting away the underlying module structure.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="ibbi.ModelType" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ModelType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;ModelType&#39;</span><span class="p">,</span> <span class="n">YOLOSingleClassBeetleDetector</span><span class="p">,</span> <span class="n">RTDETRSingleClassBeetleDetector</span><span class="p">,</span> <span class="n">YOLOBeetleMultiClassDetector</span><span class="p">,</span> <span class="n">RTDETRBeetleMultiClassDetector</span><span class="p">,</span> <span class="n">GroundingDINOModel</span><span class="p">,</span> <span class="n">YOLOWorldModel</span><span class="p">,</span> <span class="n">UntrainedFeatureExtractor</span><span class="p">,</span> <span class="n">HuggingFaceFeatureExtractor</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>A generic TypeVar for representing any of the model wrapper classes in the ibbi package.</p>
<p>This is used for type hinting in functions and methods that can accept or return any
of the available model types, providing flexibility while maintaining static type safety.</p>

    </div>

</div>


<div class="doc doc-object doc-class">



<h3 id="ibbi.Evaluator" class="doc doc-heading">
            <code>Evaluator</code>


</h3>


    <div class="doc doc-contents ">


        <p>A unified evaluator for assessing IBBI models on various tasks.</p>
<p>This class provides a streamlined interface for evaluating the performance of
models on tasks such as classification, object detection, and embedding quality.
It handles the boilerplate code for iterating through datasets, making predictions,
and calculating a comprehensive suite of metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelType = TypeVar('ModelType', YOLOSingleClassBeetleDetector, RTDETRSingleClassBeetleDetector, YOLOBeetleMultiClassDetector, RTDETRBeetleMultiClassDetector, GroundingDINOModel, YOLOWorldModel, UntrainedFeatureExtractor, HuggingFaceFeatureExtractor)

  
      module-attribute
   (ibbi.models.ModelType)" href="#ibbi.ModelType">ModelType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instantiated model from the <code>ibbi</code> package that will be evaluated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src\ibbi\evaluate\__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Evaluator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A unified evaluator for assessing IBBI models on various tasks.</span>

<span class="sd">    This class provides a streamlined interface for evaluating the performance of</span>
<span class="sd">    models on tasks such as classification, object detection, and embedding quality.</span>
<span class="sd">    It handles the boilerplate code for iterating through datasets, making predictions,</span>
<span class="sd">    and calculating a comprehensive suite of metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (ModelType): An instantiated model from the `ibbi` package that will be evaluated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the Evaluator with a specific model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (ModelType): The model to be evaluated. This should be an instance of a class</span>
<span class="sd">                               that adheres to the `ModelType` protocol, meaning it has `predict`</span>
<span class="sd">                               and `extract_features` methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">classification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">predict_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs a full classification performance analysis.</span>

<span class="sd">        This method evaluates the model&#39;s ability to correctly classify objects in a dataset.</span>
<span class="sd">        It iterates through the provided dataset, makes predictions using the model, and then</span>
<span class="sd">        compares these predictions against the ground truth labels to compute a suite of</span>
<span class="sd">        classification metrics.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: A dataset object that is iterable and contains items with &#39;image&#39; and &#39;objects&#39; keys.</span>
<span class="sd">                     The &#39;objects&#39; key should be a dictionary containing a &#39;category&#39; key, which is a list of labels.</span>
<span class="sd">            predict_kwargs (Optional[dict[str, Any]], optional): A dictionary of keyword arguments to be passed</span>
<span class="sd">                                                               to the model&#39;s `predict` method. Defaults to None.</span>
<span class="sd">            **kwargs: Additional keyword arguments to be passed to the `classification_performance` function.</span>
<span class="sd">                      See `ibbi.evaluate.classification.classification_performance` for more details.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing a comprehensive set of classification metrics, including accuracy,</span>
<span class="sd">                  precision, recall, F1-score, and a confusion matrix. Returns an empty dictionary if the</span>
<span class="sd">                  model is not suitable for classification or if the dataset is not properly formatted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">predict_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running classification evaluation...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">HuggingFaceFeatureExtractor</span><span class="p">,</span> <span class="n">GroundingDINOModel</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Classification evaluation is not supported for this model type.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;get_classes&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Model does not have a &#39;get_classes&#39; method for class mapping. Skipping classification.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">raw_model_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">model_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_classes</span> <span class="o">=</span> <span class="n">raw_model_classes</span>
        <span class="n">class_name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_classes</span><span class="p">)}</span>
        <span class="n">true_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">items_for_prediction</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                <span class="n">label_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                    <span class="n">true_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label_name</span><span class="p">])</span>
                    <span class="n">items_for_prediction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">true_labels</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No valid labels found in the dataset that match the model&#39;s classes. Skipping classification.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">predicted_labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making predictions for classification report...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">items_for_prediction</span><span class="p">)):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">predict_kwargs</span><span class="p">)</span>
            <span class="n">true_label_for_item</span> <span class="o">=</span> <span class="n">true_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">):</span>
                <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">pred_labels_for_item</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">pred_classes</span> <span class="o">=</span> <span class="p">{</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_labels_for_item</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">true_label_for_item</span> <span class="ow">in</span> <span class="n">pred_classes</span><span class="p">:</span>
                <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true_label_for_item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pred_labels_for_item</span><span class="p">:</span>
                <span class="c1"># Find the label with the highest score</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">scores</span><span class="p">:</span>
                    <span class="n">highest_conf_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
                    <span class="n">highest_conf_label</span> <span class="o">=</span> <span class="n">pred_labels_for_item</span><span class="p">[</span><span class="n">highest_conf_idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">highest_conf_label</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                        <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">highest_conf_label</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># This removes the duplicate &#39;target_names&#39; argument from kwargs if it exists</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;target_names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">classification_performance</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_labels</span><span class="p">),</span> <span class="n">target_names</span><span class="o">=</span><span class="n">model_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">object_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">iou_thresholds</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">predict_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runs a mean Average Precision (mAP) object detection analysis.</span>

<span class="sd">        This method assesses the model&#39;s ability to accurately localize objects within an image.</span>
<span class="sd">        It processes a dataset to extract both ground truth and predicted bounding boxes, then</span>
<span class="sd">        computes the mean Average Precision (mAP) at specified Intersection over Union (IoU)</span>
<span class="sd">        thresholds.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: A dataset object that is iterable and contains items with &#39;image&#39; and &#39;objects&#39; keys.</span>
<span class="sd">                     The &#39;objects&#39; key should be a dictionary with &#39;bbox&#39; and &#39;category&#39; keys.</span>
<span class="sd">            iou_thresholds (Union[float, list[float]], optional): The IoU threshold(s) at which to compute mAP.</span>
<span class="sd">                                                                    Can be a single float or a list of floats.</span>
<span class="sd">                                                                    Defaults to 0.5.</span>
<span class="sd">            predict_kwargs (Optional[dict[str, Any]], optional): A dictionary of keyword arguments to be passed</span>
<span class="sd">                                                               to the model&#39;s `predict` method. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing object detection performance metrics, including mAP scores.</span>
<span class="sd">                  Returns an empty dictionary if the model is not suitable for object detection or if</span>
<span class="sd">                  the dataset is not properly formatted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">predict_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">predict_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running object detection evaluation...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">HuggingFaceFeatureExtractor</span><span class="p">,</span> <span class="n">GroundingDINOModel</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Object detection evaluation is not supported for this model type.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;get_classes&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Model does not have a &#39;get_classes&#39; method for class mapping. Skipping object detection.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">raw_model_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">model_classes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_classes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_model_classes</span>
        <span class="n">class_name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_classes</span><span class="p">)}</span>
        <span class="n">idx_to_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">model_classes</span><span class="p">))</span>

        <span class="n">gt_boxes</span><span class="p">,</span> <span class="n">gt_labels</span><span class="p">,</span> <span class="n">gt_image_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">pred_boxes</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">pred_scores</span><span class="p">,</span> <span class="n">pred_image_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting ground truth and making predictions for mAP...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
            <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s2">&quot;bbox&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">])):</span>
                    <span class="n">label_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                        <span class="n">bbox</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;bbox&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">bbox</span>
                        <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">w</span>
                        <span class="n">y2</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">h</span>
                        <span class="n">gt_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                        <span class="n">gt_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label_name</span><span class="p">])</span>
                        <span class="n">gt_image_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">predict_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boxes&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]):</span>
                    <span class="n">box_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                    <span class="n">pred_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_coords</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                        <span class="n">pred_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pred_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">pred_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                    <span class="n">pred_image_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">performance_results</span> <span class="o">=</span> <span class="n">object_detection_performance</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gt_boxes</span><span class="p">),</span>
            <span class="n">gt_labels</span><span class="p">,</span>
            <span class="n">gt_image_ids</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">),</span>
            <span class="n">pred_labels</span><span class="p">,</span>
            <span class="n">pred_scores</span><span class="p">,</span>
            <span class="n">pred_image_ids</span><span class="p">,</span>
            <span class="n">iou_thresholds</span><span class="o">=</span><span class="n">iou_thresholds</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;per_class_AP_at_last_iou&quot;</span> <span class="ow">in</span> <span class="n">performance_results</span><span class="p">:</span>
            <span class="n">class_aps</span> <span class="o">=</span> <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;per_class_AP_at_last_iou&quot;</span><span class="p">]</span>
            <span class="n">named_class_aps</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;unknown_class_</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">ap</span> <span class="k">for</span> <span class="n">class_id</span><span class="p">,</span> <span class="n">ap</span> <span class="ow">in</span> <span class="n">class_aps</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;per_class_AP_at_last_iou&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">named_class_aps</span>

        <span class="k">if</span> <span class="s2">&quot;sample_results&quot;</span> <span class="ow">in</span> <span class="n">performance_results</span><span class="p">:</span>
            <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">idx_to_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">performance_results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">embeddings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="n">use_umap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">extract_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluates the quality of the model&#39;s feature embeddings.</span>

<span class="sd">        This method extracts feature embeddings from the provided dataset using the model&#39;s</span>
<span class="sd">        `extract_features` method. It then uses the `EmbeddingEvaluator` to compute a variety</span>
<span class="sd">        of metrics that assess the quality of these embeddings, such as clustering performance</span>
<span class="sd">        and correlation with ground truth labels.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset: An iterable dataset where each item contains an &#39;image&#39; key.</span>
<span class="sd">            use_umap (bool, optional): Whether to use UMAP for dimensionality reduction before clustering.</span>
<span class="sd">                                     Defaults to True.</span>
<span class="sd">            extract_kwargs (Optional[dict[str, Any]], optional): A dictionary of keyword arguments to be passed</span>
<span class="sd">                                                                to the model&#39;s `extract_features` method. Defaults to None.</span>
<span class="sd">            **kwargs: Additional keyword arguments to be passed to the `EmbeddingEvaluator`.</span>
<span class="sd">                      See `ibbi.evaluate.embeddings.EmbeddingEvaluator` for more details.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the results of the embedding evaluation, including</span>
<span class="sd">                  internal and external cluster validation metrics, and optionally a Mantel test</span>
<span class="sd">                  correlation. Returns an empty dictionary if no valid embeddings can be extracted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">extract_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extract_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting embeddings for evaluation...&quot;</span><span class="p">)</span>
        <span class="n">embeddings_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">extract_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="p">)]</span>

        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">emb</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">emb</span> <span class="ow">in</span> <span class="n">embeddings_list</span> <span class="k">if</span> <span class="n">emb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Could not extract any valid embeddings from the dataset.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">EmbeddingEvaluator</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">use_umap</span><span class="o">=</span><span class="n">use_umap</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;internal_cluster_validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate_cluster_structure</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">],</span> <span class="s2">&quot;feature&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="p">:</span>
            <span class="n">true_labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">unique_labels_lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cat</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]))</span>
            <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_labels_lst</span><span class="p">)</span>
            <span class="n">name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)}</span>
            <span class="n">idx_to_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                    <span class="n">label_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">name_to_idx</span><span class="p">:</span>
                        <span class="n">true_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">[</span><span class="n">label_name</span><span class="p">])</span>
                        <span class="n">valid_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">true_labels</span><span class="p">:</span>
                <span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_labels</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;external_cluster_validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate_against_truth</span><span class="p">(</span><span class="n">true_labels</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">get_sample_results</span><span class="p">(</span><span class="n">true_labels</span><span class="p">,</span> <span class="n">label_map</span><span class="o">=</span><span class="n">idx_to_name</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">valid_embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                        <span class="n">evaluator_for_mantel</span> <span class="o">=</span> <span class="n">EmbeddingEvaluator</span><span class="p">(</span><span class="n">valid_embeddings</span><span class="p">,</span> <span class="n">use_umap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                        <span class="n">mantel_corr</span><span class="p">,</span> <span class="n">p_val</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">per_class_df</span> <span class="o">=</span> <span class="n">evaluator_for_mantel</span><span class="o">.</span><span class="n">compare_to_distance_matrix</span><span class="p">(</span><span class="n">true_labels</span><span class="p">,</span> <span class="n">label_map</span><span class="o">=</span><span class="n">idx_to_name</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mantel_correlation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">mantel_corr</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span> <span class="s2">&quot;n_items&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;per_class_centroids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">per_class_df</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough unique labels in the dataset subset to run the Mantel test.&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not run Mantel test: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">get_sample_results</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset does not have the required &#39;objects&#39; and &#39;category&#39; fields for external validation.&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">get_sample_results</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ibbi.Evaluator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initializes the Evaluator with a specific model.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelType = TypeVar('ModelType', YOLOSingleClassBeetleDetector, RTDETRSingleClassBeetleDetector, YOLOBeetleMultiClassDetector, RTDETRBeetleMultiClassDetector, GroundingDINOModel, YOLOWorldModel, UntrainedFeatureExtractor, HuggingFaceFeatureExtractor)

  
      module-attribute
   (ibbi.models.ModelType)" href="#ibbi.ModelType">ModelType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model to be evaluated. This should be an instance of a class
               that adheres to the <code>ModelType</code> protocol, meaning it has <code>predict</code>
               and <code>extract_features</code> methods.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\evaluate\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the Evaluator with a specific model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (ModelType): The model to be evaluated. This should be an instance of a class</span>
<span class="sd">                           that adheres to the `ModelType` protocol, meaning it has `predict`</span>
<span class="sd">                           and `extract_features` methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ibbi.Evaluator.classification" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">classification</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">predict_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Runs a full classification performance analysis.</p>
<p>This method evaluates the model's ability to correctly classify objects in a dataset.
It iterates through the provided dataset, makes predictions using the model, and then
compares these predictions against the ground truth labels to compute a suite of
classification metrics.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataset</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dataset object that is iterable and contains items with 'image' and 'objects' keys.
     The 'objects' key should be a dictionary containing a 'category' key, which is a list of labels.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predict_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of keyword arguments to be passed
                                               to the model's <code>predict</code> method. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to be passed to the <code>classification_performance</code> function.
      See <code>ibbi.evaluate.classification.classification_performance</code> for more details.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing a comprehensive set of classification metrics, including accuracy,
  precision, recall, F1-score, and a confusion matrix. Returns an empty dictionary if the
  model is not suitable for classification or if the dataset is not properly formatted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\evaluate\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">classification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">predict_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runs a full classification performance analysis.</span>

<span class="sd">    This method evaluates the model&#39;s ability to correctly classify objects in a dataset.</span>
<span class="sd">    It iterates through the provided dataset, makes predictions using the model, and then</span>
<span class="sd">    compares these predictions against the ground truth labels to compute a suite of</span>
<span class="sd">    classification metrics.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset: A dataset object that is iterable and contains items with &#39;image&#39; and &#39;objects&#39; keys.</span>
<span class="sd">                 The &#39;objects&#39; key should be a dictionary containing a &#39;category&#39; key, which is a list of labels.</span>
<span class="sd">        predict_kwargs (Optional[dict[str, Any]], optional): A dictionary of keyword arguments to be passed</span>
<span class="sd">                                                           to the model&#39;s `predict` method. Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to be passed to the `classification_performance` function.</span>
<span class="sd">                  See `ibbi.evaluate.classification.classification_performance` for more details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing a comprehensive set of classification metrics, including accuracy,</span>
<span class="sd">              precision, recall, F1-score, and a confusion matrix. Returns an empty dictionary if the</span>
<span class="sd">              model is not suitable for classification or if the dataset is not properly formatted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">predict_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">predict_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running classification evaluation...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">HuggingFaceFeatureExtractor</span><span class="p">,</span> <span class="n">GroundingDINOModel</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Classification evaluation is not supported for this model type.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;get_classes&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Model does not have a &#39;get_classes&#39; method for class mapping. Skipping classification.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw_model_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">model_classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_classes</span> <span class="o">=</span> <span class="n">raw_model_classes</span>
    <span class="n">class_name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_classes</span><span class="p">)}</span>
    <span class="n">true_labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">items_for_prediction</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
            <span class="n">label_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                <span class="n">true_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label_name</span><span class="p">])</span>
                <span class="n">items_for_prediction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">true_labels</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No valid labels found in the dataset that match the model&#39;s classes. Skipping classification.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">predicted_labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making predictions for classification report...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">items_for_prediction</span><span class="p">)):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">predict_kwargs</span><span class="p">)</span>
        <span class="n">true_label_for_item</span> <span class="o">=</span> <span class="n">true_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">):</span>
            <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">pred_labels_for_item</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">pred_classes</span> <span class="o">=</span> <span class="p">{</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_labels_for_item</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">true_label_for_item</span> <span class="ow">in</span> <span class="n">pred_classes</span><span class="p">:</span>
            <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true_label_for_item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pred_labels_for_item</span><span class="p">:</span>
            <span class="c1"># Find the label with the highest score</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">scores</span><span class="p">:</span>
                <span class="n">highest_conf_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
                <span class="n">highest_conf_label</span> <span class="o">=</span> <span class="n">pred_labels_for_item</span><span class="p">[</span><span class="n">highest_conf_idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">highest_conf_label</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                    <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">highest_conf_label</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predicted_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># This removes the duplicate &#39;target_names&#39; argument from kwargs if it exists</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;target_names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">classification_performance</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_labels</span><span class="p">),</span> <span class="n">target_names</span><span class="o">=</span><span class="n">model_classes</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ibbi.Evaluator.embeddings" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">embeddings</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">use_umap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extract_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluates the quality of the model's feature embeddings.</p>
<p>This method extracts feature embeddings from the provided dataset using the model's
<code>extract_features</code> method. It then uses the <code>EmbeddingEvaluator</code> to compute a variety
of metrics that assess the quality of these embeddings, such as clustering performance
and correlation with ground truth labels.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataset</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An iterable dataset where each item contains an 'image' key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_umap</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to use UMAP for dimensionality reduction before clustering.
                     Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extract_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of keyword arguments to be passed
                                                to the model's <code>extract_features</code> method. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to be passed to the <code>EmbeddingEvaluator</code>.
      See <code>ibbi.evaluate.embeddings.EmbeddingEvaluator</code> for more details.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the results of the embedding evaluation, including
  internal and external cluster validation metrics, and optionally a Mantel test
  correlation. Returns an empty dictionary if no valid embeddings can be extracted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\evaluate\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">embeddings</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">,</span>
    <span class="n">use_umap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">extract_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluates the quality of the model&#39;s feature embeddings.</span>

<span class="sd">    This method extracts feature embeddings from the provided dataset using the model&#39;s</span>
<span class="sd">    `extract_features` method. It then uses the `EmbeddingEvaluator` to compute a variety</span>
<span class="sd">    of metrics that assess the quality of these embeddings, such as clustering performance</span>
<span class="sd">    and correlation with ground truth labels.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset: An iterable dataset where each item contains an &#39;image&#39; key.</span>
<span class="sd">        use_umap (bool, optional): Whether to use UMAP for dimensionality reduction before clustering.</span>
<span class="sd">                                 Defaults to True.</span>
<span class="sd">        extract_kwargs (Optional[dict[str, Any]], optional): A dictionary of keyword arguments to be passed</span>
<span class="sd">                                                            to the model&#39;s `extract_features` method. Defaults to None.</span>
<span class="sd">        **kwargs: Additional keyword arguments to be passed to the `EmbeddingEvaluator`.</span>
<span class="sd">                  See `ibbi.evaluate.embeddings.EmbeddingEvaluator` for more details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the results of the embedding evaluation, including</span>
<span class="sd">              internal and external cluster validation metrics, and optionally a Mantel test</span>
<span class="sd">              correlation. Returns an empty dictionary if no valid embeddings can be extracted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">extract_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">extract_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting embeddings for evaluation...&quot;</span><span class="p">)</span>
    <span class="n">embeddings_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">extract_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="p">)]</span>

    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">emb</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">emb</span> <span class="ow">in</span> <span class="n">embeddings_list</span> <span class="k">if</span> <span class="n">emb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Could not extract any valid embeddings from the dataset.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">evaluator</span> <span class="o">=</span> <span class="n">EmbeddingEvaluator</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">use_umap</span><span class="o">=</span><span class="n">use_umap</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;internal_cluster_validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate_cluster_structure</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">],</span> <span class="s2">&quot;feature&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="p">:</span>
        <span class="n">true_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_labels_lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cat</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]))</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_labels_lst</span><span class="p">)</span>
        <span class="n">name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)}</span>
        <span class="n">idx_to_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                <span class="n">label_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">name_to_idx</span><span class="p">:</span>
                    <span class="n">true_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">[</span><span class="n">label_name</span><span class="p">])</span>
                    <span class="n">valid_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">true_labels</span><span class="p">:</span>
            <span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">true_labels</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;external_cluster_validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate_against_truth</span><span class="p">(</span><span class="n">true_labels</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">get_sample_results</span><span class="p">(</span><span class="n">true_labels</span><span class="p">,</span> <span class="n">label_map</span><span class="o">=</span><span class="n">idx_to_name</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">valid_embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="p">[</span><span class="n">valid_indices</span><span class="p">]</span>
                    <span class="n">evaluator_for_mantel</span> <span class="o">=</span> <span class="n">EmbeddingEvaluator</span><span class="p">(</span><span class="n">valid_embeddings</span><span class="p">,</span> <span class="n">use_umap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">mantel_corr</span><span class="p">,</span> <span class="n">p_val</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">per_class_df</span> <span class="o">=</span> <span class="n">evaluator_for_mantel</span><span class="o">.</span><span class="n">compare_to_distance_matrix</span><span class="p">(</span><span class="n">true_labels</span><span class="p">,</span> <span class="n">label_map</span><span class="o">=</span><span class="n">idx_to_name</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;mantel_correlation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">mantel_corr</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span> <span class="s2">&quot;n_items&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">}</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;per_class_centroids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">per_class_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not enough unique labels in the dataset subset to run the Mantel test.&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not run Mantel test: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">get_sample_results</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset does not have the required &#39;objects&#39; and &#39;category&#39; fields for external validation.&quot;</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">get_sample_results</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ibbi.Evaluator.object_detection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">object_detection</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">iou_thresholds</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">predict_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Runs a mean Average Precision (mAP) object detection analysis.</p>
<p>This method assesses the model's ability to accurately localize objects within an image.
It processes a dataset to extract both ground truth and predicted bounding boxes, then
computes the mean Average Precision (mAP) at specified Intersection over Union (IoU)
thresholds.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dataset</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dataset object that is iterable and contains items with 'image' and 'objects' keys.
     The 'objects' key should be a dictionary with 'bbox' and 'category' keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>iou_thresholds</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="float">float</span>, <span title="list">list</span>[<span title="float">float</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The IoU threshold(s) at which to compute mAP.
                                                    Can be a single float or a list of floats.
                                                    Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>predict_kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of keyword arguments to be passed
                                               to the model's <code>predict</code> method. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing object detection performance metrics, including mAP scores.
  Returns an empty dictionary if the model is not suitable for object detection or if
  the dataset is not properly formatted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\evaluate\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">object_detection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">iou_thresholds</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">predict_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Runs a mean Average Precision (mAP) object detection analysis.</span>

<span class="sd">    This method assesses the model&#39;s ability to accurately localize objects within an image.</span>
<span class="sd">    It processes a dataset to extract both ground truth and predicted bounding boxes, then</span>
<span class="sd">    computes the mean Average Precision (mAP) at specified Intersection over Union (IoU)</span>
<span class="sd">    thresholds.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset: A dataset object that is iterable and contains items with &#39;image&#39; and &#39;objects&#39; keys.</span>
<span class="sd">                 The &#39;objects&#39; key should be a dictionary with &#39;bbox&#39; and &#39;category&#39; keys.</span>
<span class="sd">        iou_thresholds (Union[float, list[float]], optional): The IoU threshold(s) at which to compute mAP.</span>
<span class="sd">                                                                Can be a single float or a list of floats.</span>
<span class="sd">                                                                Defaults to 0.5.</span>
<span class="sd">        predict_kwargs (Optional[dict[str, Any]], optional): A dictionary of keyword arguments to be passed</span>
<span class="sd">                                                           to the model&#39;s `predict` method. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing object detection performance metrics, including mAP scores.</span>
<span class="sd">              Returns an empty dictionary if the model is not suitable for object detection or if</span>
<span class="sd">              the dataset is not properly formatted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">predict_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">predict_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running object detection evaluation...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="n">HuggingFaceFeatureExtractor</span><span class="p">,</span> <span class="n">GroundingDINOModel</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Object detection evaluation is not supported for this model type.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;get_classes&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Model does not have a &#39;get_classes&#39; method for class mapping. Skipping object detection.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">raw_model_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_classes</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">model_classes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">raw_model_classes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_classes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_model_classes</span>
    <span class="n">class_name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_classes</span><span class="p">)}</span>
    <span class="n">idx_to_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">model_classes</span><span class="p">))</span>

    <span class="n">gt_boxes</span><span class="p">,</span> <span class="n">gt_labels</span><span class="p">,</span> <span class="n">gt_image_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">pred_boxes</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">pred_scores</span><span class="p">,</span> <span class="n">pred_image_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting ground truth and making predictions for mAP...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
        <span class="k">if</span> <span class="s2">&quot;objects&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s2">&quot;bbox&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;category&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">])):</span>
                <span class="n">label_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;category&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                    <span class="n">bbox</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;objects&quot;</span><span class="p">][</span><span class="s2">&quot;bbox&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">bbox</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">w</span>
                    <span class="n">y2</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">h</span>
                    <span class="n">gt_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
                    <span class="n">gt_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label_name</span><span class="p">])</span>
                    <span class="n">gt_image_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">predict_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;boxes&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;boxes&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]):</span>
                <span class="n">box_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                <span class="n">pred_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_coords</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">class_name_to_idx</span><span class="p">:</span>
                    <span class="n">pred_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_name_to_idx</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pred_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">pred_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="n">pred_image_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">performance_results</span> <span class="o">=</span> <span class="n">object_detection_performance</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gt_boxes</span><span class="p">),</span>
        <span class="n">gt_labels</span><span class="p">,</span>
        <span class="n">gt_image_ids</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_boxes</span><span class="p">),</span>
        <span class="n">pred_labels</span><span class="p">,</span>
        <span class="n">pred_scores</span><span class="p">,</span>
        <span class="n">pred_image_ids</span><span class="p">,</span>
        <span class="n">iou_thresholds</span><span class="o">=</span><span class="n">iou_thresholds</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;per_class_AP_at_last_iou&quot;</span> <span class="ow">in</span> <span class="n">performance_results</span><span class="p">:</span>
        <span class="n">class_aps</span> <span class="o">=</span> <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;per_class_AP_at_last_iou&quot;</span><span class="p">]</span>
        <span class="n">named_class_aps</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx_to_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_id</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;unknown_class_</span><span class="si">{</span><span class="n">class_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span> <span class="n">ap</span> <span class="k">for</span> <span class="n">class_id</span><span class="p">,</span> <span class="n">ap</span> <span class="ow">in</span> <span class="n">class_aps</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;per_class_AP_at_last_iou&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">named_class_aps</span>

    <span class="k">if</span> <span class="s2">&quot;sample_results&quot;</span> <span class="ow">in</span> <span class="n">performance_results</span><span class="p">:</span>
        <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">performance_results</span><span class="p">[</span><span class="s2">&quot;sample_results&quot;</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">idx_to_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">performance_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="ibbi.Explainer" class="doc doc-heading">
            <code>Explainer</code>


</h3>


    <div class="doc doc-contents ">


        <p>A wrapper for LIME and SHAP explainability methods.</p>
<p>This class provides a simple interface to generate model explanations using
either LIME (Local Interpretable Model-agnostic Explanations) or SHAP
(SHapley Additive exPlanations). It is designed to work with any model
created using <code>ibbi.create_model</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelType = TypeVar('ModelType', YOLOSingleClassBeetleDetector, RTDETRSingleClassBeetleDetector, YOLOBeetleMultiClassDetector, RTDETRBeetleMultiClassDetector, GroundingDINOModel, YOLOWorldModel, UntrainedFeatureExtractor, HuggingFaceFeatureExtractor)

  
      module-attribute
   (ibbi.models.ModelType)" href="#ibbi.ModelType">ModelType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instantiated model from <code>ibbi.create_model</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>src\ibbi\explain\__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Explainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A wrapper for LIME and SHAP explainability methods.</span>

<span class="sd">    This class provides a simple interface to generate model explanations using</span>
<span class="sd">    either LIME (Local Interpretable Model-agnostic Explanations) or SHAP</span>
<span class="sd">    (SHapley Additive exPlanations). It is designed to work with any model</span>
<span class="sd">    created using `ibbi.create_model`.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (ModelType): An instantiated model from `ibbi.create_model`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A wrapper for LIME and SHAP explainability methods.</span>

<span class="sd">        This class provides a simple interface to generate model explanations using</span>
<span class="sd">        either LIME (Local Interpretable Model-agnostic Explanations) or SHAP</span>
<span class="sd">        (SHapley Additive exPlanations). It is designed to work with any model</span>
<span class="sd">        created using `ibbi.create_model`.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (ModelType): An instantiated model from `ibbi.create_model`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_lime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates a LIME explanation for a single image.</span>

<span class="sd">        LIME provides a local, intuitive explanation by showing which parts of an image</span>
<span class="sd">        contributed most to a specific prediction. This method is a wrapper around</span>
<span class="sd">        the `explain_with_lime` function.</span>

<span class="sd">        Args:</span>
<span class="sd">            image (PIL.Image.Image): The single image to be explained.</span>
<span class="sd">            **kwargs: Additional keyword arguments to be passed to the underlying</span>
<span class="sd">                      `ibbi.explain.lime.explain_with_lime` function. Common arguments</span>
<span class="sd">                      include `image_size`, `batch_size`, `num_samples`, `top_labels`,</span>
<span class="sd">                      and `num_features`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[lime_image.ImageExplanation, PIL.Image.Image]: A tuple containing the LIME</span>
<span class="sd">            explanation object and the original image. The explanation object can be</span>
<span class="sd">            visualized using `ibbi.plot_lime_explanation`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">explain_with_lime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_shap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explain_dataset</span><span class="p">,</span> <span class="n">background_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates SHAP explanations for a set of images.</span>

<span class="sd">        SHAP (SHapley Additive exPlanations) provides robust, theoretically-grounded</span>
<span class="sd">        explanations by attributing a model&#39;s prediction to its input features. This</span>
<span class="sd">        method is a wrapper around the `explain_with_shap` function and requires a</span>
<span class="sd">        background dataset to integrate out features.</span>

<span class="sd">        Args:</span>
<span class="sd">            explain_dataset (list): A list of dictionaries, where each dictionary</span>
<span class="sd">                                    represents an image to be explained (e.g., `[{&#39;image&#39;: img1}, {&#39;image&#39;: img2}]`).</span>
<span class="sd">            background_dataset (list): A list of dictionaries representing a background dataset,</span>
<span class="sd">                                       used by SHAP to simulate feature absence.</span>
<span class="sd">            **kwargs: Additional keyword arguments to be passed to the underlying</span>
<span class="sd">                      `ibbi.explain.shap.explain_with_shap` function. Common arguments</span>
<span class="sd">                      include `num_explain_samples`, `max_evals`, `image_size`, and `text_prompt`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            shap.Explanation: A SHAP Explanation object containing the SHAP values for each</span>
<span class="sd">                              image and each class. This object can be visualized using</span>
<span class="sd">                              `ibbi.plot_shap_explanation`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">explain_with_shap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">explain_dataset</span><span class="p">,</span> <span class="n">background_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ibbi.Explainer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>A wrapper for LIME and SHAP explainability methods.</p>
<p>This class provides a simple interface to generate model explanations using
either LIME (Local Interpretable Model-agnostic Explanations) or SHAP
(SHapley Additive exPlanations). It is designed to work with any model
created using <code>ibbi.create_model</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelType = TypeVar('ModelType', YOLOSingleClassBeetleDetector, RTDETRSingleClassBeetleDetector, YOLOBeetleMultiClassDetector, RTDETRBeetleMultiClassDetector, GroundingDINOModel, YOLOWorldModel, UntrainedFeatureExtractor, HuggingFaceFeatureExtractor)

  
      module-attribute
   (ibbi.models.ModelType)" href="#ibbi.ModelType">ModelType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instantiated model from <code>ibbi.create_model</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\explain\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A wrapper for LIME and SHAP explainability methods.</span>

<span class="sd">    This class provides a simple interface to generate model explanations using</span>
<span class="sd">    either LIME (Local Interpretable Model-agnostic Explanations) or SHAP</span>
<span class="sd">    (SHapley Additive exPlanations). It is designed to work with any model</span>
<span class="sd">    created using `ibbi.create_model`.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (ModelType): An instantiated model from `ibbi.create_model`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ibbi.Explainer.with_lime" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">with_lime</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generates a LIME explanation for a single image.</p>
<p>LIME provides a local, intuitive explanation by showing which parts of an image
contributed most to a specific prediction. This method is a wrapper around
the <code>explain_with_lime</code> function.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="PIL.Image.Image">Image</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The single image to be explained.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to be passed to the underlying
      <code>ibbi.explain.lime.explain_with_lime</code> function. Common arguments
      include <code>image_size</code>, <code>batch_size</code>, <code>num_samples</code>, <code>top_labels</code>,
      and <code>num_features</code>.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[lime_image.ImageExplanation, PIL.Image.Image]: A tuple containing the LIME</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>explanation object and the original image. The explanation object can be</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>visualized using <code>ibbi.plot_lime_explanation</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\explain\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_lime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates a LIME explanation for a single image.</span>

<span class="sd">    LIME provides a local, intuitive explanation by showing which parts of an image</span>
<span class="sd">    contributed most to a specific prediction. This method is a wrapper around</span>
<span class="sd">    the `explain_with_lime` function.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (PIL.Image.Image): The single image to be explained.</span>
<span class="sd">        **kwargs: Additional keyword arguments to be passed to the underlying</span>
<span class="sd">                  `ibbi.explain.lime.explain_with_lime` function. Common arguments</span>
<span class="sd">                  include `image_size`, `batch_size`, `num_samples`, `top_labels`,</span>
<span class="sd">                  and `num_features`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[lime_image.ImageExplanation, PIL.Image.Image]: A tuple containing the LIME</span>
<span class="sd">        explanation object and the original image. The explanation object can be</span>
<span class="sd">        visualized using `ibbi.plot_lime_explanation`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">explain_with_lime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ibbi.Explainer.with_shap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">with_shap</span><span class="p">(</span><span class="n">explain_dataset</span><span class="p">,</span> <span class="n">background_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generates SHAP explanations for a set of images.</p>
<p>SHAP (SHapley Additive exPlanations) provides robust, theoretically-grounded
explanations by attributing a model's prediction to its input features. This
method is a wrapper around the <code>explain_with_shap</code> function and requires a
background dataset to integrate out features.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>explain_dataset</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries, where each dictionary
                    represents an image to be explained (e.g., <code>[{'image': img1}, {'image': img2}]</code>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>background_dataset</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries representing a background dataset,
                       used by SHAP to simulate feature absence.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments to be passed to the underlying
      <code>ibbi.explain.shap.explain_with_shap</code> function. Common arguments
      include <code>num_explain_samples</code>, <code>max_evals</code>, <code>image_size</code>, and <code>text_prompt</code>.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>shap.Explanation: A SHAP Explanation object containing the SHAP values for each
              image and each class. This object can be visualized using
              <code>ibbi.plot_shap_explanation</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\explain\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">with_shap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">explain_dataset</span><span class="p">,</span> <span class="n">background_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generates SHAP explanations for a set of images.</span>

<span class="sd">    SHAP (SHapley Additive exPlanations) provides robust, theoretically-grounded</span>
<span class="sd">    explanations by attributing a model&#39;s prediction to its input features. This</span>
<span class="sd">    method is a wrapper around the `explain_with_shap` function and requires a</span>
<span class="sd">    background dataset to integrate out features.</span>

<span class="sd">    Args:</span>
<span class="sd">        explain_dataset (list): A list of dictionaries, where each dictionary</span>
<span class="sd">                                represents an image to be explained (e.g., `[{&#39;image&#39;: img1}, {&#39;image&#39;: img2}]`).</span>
<span class="sd">        background_dataset (list): A list of dictionaries representing a background dataset,</span>
<span class="sd">                                   used by SHAP to simulate feature absence.</span>
<span class="sd">        **kwargs: Additional keyword arguments to be passed to the underlying</span>
<span class="sd">                  `ibbi.explain.shap.explain_with_shap` function. Common arguments</span>
<span class="sd">                  include `num_explain_samples`, `max_evals`, `image_size`, and `text_prompt`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        shap.Explanation: A SHAP Explanation object containing the SHAP values for each</span>
<span class="sd">                          image and each class. This object can be visualized using</span>
<span class="sd">                          `ibbi.plot_shap_explanation`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">explain_with_shap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">explain_dataset</span><span class="p">,</span> <span class="n">background_dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="ibbi.clean_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_cache</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Removes the entire ibbi cache directory.</p>
<p>This function will permanently delete all downloaded models and datasets
associated with the <code>ibbi</code> package's cache. This can be useful for forcing
a fresh download of all assets or for freeing up disk space.</p>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\utils\cache.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clean_cache</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes the entire ibbi cache directory.</span>

<span class="sd">    This function will permanently delete all downloaded models and datasets</span>
<span class="sd">    associated with the `ibbi` package&#39;s cache. This can be useful for forcing</span>
<span class="sd">    a fresh download of all assets or for freeing up disk space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">get_cache_dir</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cache_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing cache directory: </span><span class="si">{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cache cleaned successfully.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cache directory not found. Nothing to clean.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ibbi.create_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Creates a model from a name or a task-based alias.</p>
<p>This function is the main entry point for instantiating models within the <code>ibbi</code>
package. It uses a model registry to look up and create a model instance based on
the provided <code>model_name</code>. Users can either specify the exact name of a model
or use a convenient, task-based alias (e.g., "species_classifier").</p>
<p>When <code>pretrained=True</code>, the function will download the model's weights from the
Hugging Face Hub and cache them locally for future use.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name or alias of the model to create. A list of available
              model names and aliases can be obtained using <code>ibbi.list_models()</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pretrained</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, loads pretrained weights for the model.
                         Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that will be passed to the underlying
            model's factory function. This allows for advanced customization.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>ModelType</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelType = TypeVar('ModelType', YOLOSingleClassBeetleDetector, RTDETRSingleClassBeetleDetector, YOLOBeetleMultiClassDetector, RTDETRBeetleMultiClassDetector, GroundingDINOModel, YOLOWorldModel, UntrainedFeatureExtractor, HuggingFaceFeatureExtractor)

  
      module-attribute
   (ibbi.models.ModelType)" href="#ibbi.ModelType">ModelType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instantiated model object ready for prediction or feature extraction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the provided <code>model_name</code> or its resolved alias is not found in the
      model registry.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pretrained</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelType</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a model from a name or a task-based alias.</span>

<span class="sd">    This function is the main entry point for instantiating models within the `ibbi`</span>
<span class="sd">    package. It uses a model registry to look up and create a model instance based on</span>
<span class="sd">    the provided `model_name`. Users can either specify the exact name of a model</span>
<span class="sd">    or use a convenient, task-based alias (e.g., &quot;species_classifier&quot;).</span>

<span class="sd">    When `pretrained=True`, the function will download the model&#39;s weights from the</span>
<span class="sd">    Hugging Face Hub and cache them locally for future use.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name (str): The name or alias of the model to create. A list of available</span>
<span class="sd">                          model names and aliases can be obtained using `ibbi.list_models()`.</span>
<span class="sd">        pretrained (bool, optional): If True, loads pretrained weights for the model.</span>
<span class="sd">                                     Defaults to False.</span>
<span class="sd">        **kwargs (Any): Additional keyword arguments that will be passed to the underlying</span>
<span class="sd">                        model&#39;s factory function. This allows for advanced customization.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ModelType: An instantiated model object ready for prediction or feature extraction.</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If the provided `model_name` or its resolved alias is not found in the</span>
<span class="sd">                  model registry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Resolve alias if used</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">MODEL_ALIASES</span><span class="p">:</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">MODEL_ALIASES</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_registry</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_registry</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_ALIASES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; not found. Available models: [</span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">]. Available aliases: [</span><span class="si">{</span><span class="n">aliases</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">)</span>

    <span class="n">model_factory</span> <span class="o">=</span> <span class="n">model_registry</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model_factory</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="n">pretrained</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ibbi.get_cache_dir" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_cache_dir</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Gets the cache directory for the ibbi package.</p>
<p>This function determines the appropriate directory for storing cached files,
such as downloaded model weights and datasets. It first checks for a custom path
set by the <code>IBBI_CACHE_DIR</code> environment variable. If the variable is not set,
it defaults to a standard user cache location (<code>~/.cache/ibbi</code>).</p>
<p>The function also ensures that the cache directory exists by creating it if it
does not already.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Path</code></td>            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A <code>pathlib.Path</code> object representing the path to the cache directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\utils\cache.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_cache_dir</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the cache directory for the ibbi package.</span>

<span class="sd">    This function determines the appropriate directory for storing cached files,</span>
<span class="sd">    such as downloaded model weights and datasets. It first checks for a custom path</span>
<span class="sd">    set by the `IBBI_CACHE_DIR` environment variable. If the variable is not set,</span>
<span class="sd">    it defaults to a standard user cache location (`~/.cache/ibbi`).</span>

<span class="sd">    The function also ensures that the cache directory exists by creating it if it</span>
<span class="sd">    does not already.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path: A `pathlib.Path` object representing the path to the cache directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check for the custom environment variable</span>
    <span class="n">cache_env_var</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IBBI_CACHE_DIR&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cache_env_var</span><span class="p">:</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cache_env_var</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Default to a user&#39;s home cache directory</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;.cache&quot;</span> <span class="o">/</span> <span class="s2">&quot;ibbi&quot;</span>

    <span class="c1"># Create the directory if it doesn&#39;t exist</span>
    <span class="n">cache_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cache_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ibbi.get_dataset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_dataset</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="s1">&#39;IBBI-bio/ibbi_test_data&#39;</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="s1">&#39;ibbi_test_data&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Downloads and loads a dataset from the Hugging Face Hub.</p>
<p>This function facilitates the use of datasets hosted on the Hugging Face Hub by
handling the download and caching process. It downloads the dataset to a local
directory, and on subsequent calls, it will load the data directly from the local
cache to save time and bandwidth.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>repo_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The repository ID of the dataset on the Hugging Face Hub.
                     Defaults to "IBBI-bio/ibbi_test_data".</p>
              </div>
            </td>
            <td>
                  <code>&#39;IBBI-bio/ibbi_test_data&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>local_dir</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the local directory where the dataset will be stored.
                       Defaults to "ibbi_test_data".</p>
              </div>
            </td>
            <td>
                  <code>&#39;ibbi_test_data&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>split</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the dataset split to load (e.g., "train", "test", "validation").
                   Defaults to "train".</p>
              </div>
            </td>
            <td>
                  <code>&#39;train&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments that will be passed directly to the
      <code>datasets.load_dataset</code> function. This allows for advanced customization
      of the data loading process.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Dataset</code></td>            <td>
                  <code><span title="datasets.Dataset">Dataset</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded dataset as a <code>datasets.Dataset</code> object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the object loaded for the specified split is not of type <code>datasets.Dataset</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\utils\data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dataset</span><span class="p">(</span>
    <span class="n">repo_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IBBI-bio/ibbi_test_data&quot;</span><span class="p">,</span>
    <span class="n">local_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ibbi_test_data&quot;</span><span class="p">,</span>
    <span class="n">split</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads and loads a dataset from the Hugging Face Hub.</span>

<span class="sd">    This function facilitates the use of datasets hosted on the Hugging Face Hub by</span>
<span class="sd">    handling the download and caching process. It downloads the dataset to a local</span>
<span class="sd">    directory, and on subsequent calls, it will load the data directly from the local</span>
<span class="sd">    cache to save time and bandwidth.</span>

<span class="sd">    Args:</span>
<span class="sd">        repo_id (str, optional): The repository ID of the dataset on the Hugging Face Hub.</span>
<span class="sd">                                 Defaults to &quot;IBBI-bio/ibbi_test_data&quot;.</span>
<span class="sd">        local_dir (str, optional): The name of the local directory where the dataset will be stored.</span>
<span class="sd">                                   Defaults to &quot;ibbi_test_data&quot;.</span>
<span class="sd">        split (str, optional): The name of the dataset split to load (e.g., &quot;train&quot;, &quot;test&quot;, &quot;validation&quot;).</span>
<span class="sd">                               Defaults to &quot;train&quot;.</span>
<span class="sd">        **kwargs: Additional keyword arguments that will be passed directly to the</span>
<span class="sd">                  `datasets.load_dataset` function. This allows for advanced customization</span>
<span class="sd">                  of the data loading process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dataset: The loaded dataset as a `datasets.Dataset` object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If the object loaded for the specified split is not of type `datasets.Dataset`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dataset_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset not found locally. Downloading from &#39;</span><span class="si">{</span><span class="n">repo_id</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
        <span class="n">snapshot_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">local_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">),</span> <span class="n">local_dir_use_symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Download complete.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found cached dataset at &#39;</span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">&#39;. Loading from disk.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">DatasetDict</span><span class="p">,</span> <span class="n">IterableDataset</span><span class="p">,</span> <span class="n">IterableDatasetDict</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">),</span> <span class="n">split</span><span class="o">=</span><span class="n">split</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">Dataset</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected a &#39;Dataset&#39; object for split &#39;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">&#39;, but received type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset loaded successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load dataset from &#39;</span><span class="si">{</span><span class="n">dataset_path</span><span class="si">}</span><span class="s2">&#39;. Please check the path and your connection.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ibbi.get_shap_background_dataset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_shap_background_dataset</span><span class="p">(</span><span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Downloads, unzips, and loads the default IBBI SHAP background dataset.</p>
<p>This function is specifically designed to fetch the background dataset required for the
SHAP (SHapley Additive exPlanations) explainability method. It handles the download of a
zip archive from the Hugging Face Hub, extracts its contents, and loads the images into
memory. The data is stored in the package's central cache directory to avoid re-downloads.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>image_size</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The target size (width, height) to which the
                                    background images will be resized. This should
                                    match the input size expected by the model being
                                    explained. Defaults to (224, 224).</p>
              </div>
            </td>
            <td>
                  <code>(224, 224)</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[dict]: A list of dictionaries, where each dictionary has an "image" key with a
        resized PIL Image object. This format is ready to be used with the
        <code>ibbi.Explainer.with_shap</code> method.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\utils\data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_shap_background_dataset</span><span class="p">(</span><span class="n">image_size</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads, unzips, and loads the default IBBI SHAP background dataset.</span>

<span class="sd">    This function is specifically designed to fetch the background dataset required for the</span>
<span class="sd">    SHAP (SHapley Additive exPlanations) explainability method. It handles the download of a</span>
<span class="sd">    zip archive from the Hugging Face Hub, extracts its contents, and loads the images into</span>
<span class="sd">    memory. The data is stored in the package&#39;s central cache directory to avoid re-downloads.</span>

<span class="sd">    Args:</span>
<span class="sd">        image_size (tuple[int, int], optional): The target size (width, height) to which the</span>
<span class="sd">                                                background images will be resized. This should</span>
<span class="sd">                                                match the input size expected by the model being</span>
<span class="sd">                                                explained. Defaults to (224, 224).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[dict]: A list of dictionaries, where each dictionary has an &quot;image&quot; key with a</span>
<span class="sd">                    resized PIL Image object. This format is ready to be used with the</span>
<span class="sd">                    `ibbi.Explainer.with_shap` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">repo_id</span> <span class="o">=</span> <span class="s2">&quot;IBBI-bio/ibbi_shap_dataset&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;ibbi_shap_dataset.zip&quot;</span>
    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">get_cache_dir</span><span class="p">()</span>
    <span class="n">unzip_dir</span> <span class="o">=</span> <span class="n">cache_dir</span> <span class="o">/</span> <span class="s2">&quot;unzipped_shap_data&quot;</span>
    <span class="n">image_dir</span> <span class="o">=</span> <span class="n">unzip_dir</span> <span class="o">/</span> <span class="s2">&quot;shap_dataset&quot;</span> <span class="o">/</span> <span class="s2">&quot;images&quot;</span> <span class="o">/</span> <span class="s2">&quot;train&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">image_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHAP background data not found in cache. Downloading from &#39;</span><span class="si">{</span><span class="n">repo_id</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
        <span class="n">downloaded_zip_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">repo_id</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">repo_type</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Decompressing SHAP background dataset...&quot;</span><span class="p">)</span>
        <span class="n">unzip_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">downloaded_zip_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
            <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">unzip_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found cached SHAP background data. Loading from disk.&quot;</span><span class="p">)</span>

    <span class="n">background_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading and resizing SHAP background images to </span><span class="si">{</span><span class="n">image_size</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">image_paths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="n">image_paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
            <span class="n">resized_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image_size</span><span class="p">)</span>
            <span class="n">background_images</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">resized_img</span><span class="o">.</span><span class="n">copy</span><span class="p">()})</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SHAP background dataset loaded and resized successfully.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">background_images</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ibbi.list_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">list_models</span><span class="p">(</span><span class="n">as_df</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Displays or returns a summary of available models and their key information.</p>
<p>This function reads the model summary CSV file included with the package, which
contains a comprehensive list of all available models, their tasks, and key
performance metrics. It can either print this information to the console in a
human-readable format or return it as a pandas DataFrame for programmatic access.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>as_df</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, the function returns the model information as a
                    pandas DataFrame. If False (the default), it prints the
                    information directly to the console.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame or None: If <code>as_df</code> is True, a pandas DataFrame containing the model
                  summary is returned. Otherwise, the function returns None.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\utils\info.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_models</span><span class="p">(</span><span class="n">as_df</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Displays or returns a summary of available models and their key information.</span>

<span class="sd">    This function reads the model summary CSV file included with the package, which</span>
<span class="sd">    contains a comprehensive list of all available models, their tasks, and key</span>
<span class="sd">    performance metrics. It can either print this information to the console in a</span>
<span class="sd">    human-readable format or return it as a pandas DataFrame for programmatic access.</span>

<span class="sd">    Args:</span>
<span class="sd">        as_df (bool, optional): If True, the function returns the model information as a</span>
<span class="sd">                                pandas DataFrame. If False (the default), it prints the</span>
<span class="sd">                                information directly to the console.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame or None: If `as_df` is True, a pandas DataFrame containing the model</span>
<span class="sd">                              summary is returned. Otherwise, the function returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Find the path to the data file within the package</span>
        <span class="k">with</span> <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;ibbi.data&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;ibbi_model_summary.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">as_df</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available IBBI Models:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Model summary file not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ibbi.plot_lime_explanation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_lime_explanation</span><span class="p">(</span><span class="n">explanation</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Plots a detailed LIME explanation with a red-to-green overlay.</p>
<p>This function visualizes the output of <code>explain_with_lime</code>. It overlays the original
image with a heatmap where green areas indicate features that positively contributed
to the prediction, and red areas indicate negative contributions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>explanation</code>
            </td>
            <td>
                  <code><span title="lime.lime_image.ImageExplanation">ImageExplanation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The explanation object generated by <code>explain_with_lime</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>image</code>
            </td>
            <td>
                  <code><span title="PIL.Image.Image">Image</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original image that was explained.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top_k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of top classes to display explanations for. Defaults to 1.</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>alpha</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The transparency of the color overlay. Defaults to 0.6.</p>
              </div>
            </td>
            <td>
                  <code>0.6</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\explain\lime.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_lime_explanation</span><span class="p">(</span><span class="n">explanation</span><span class="p">:</span> <span class="n">lime_image</span><span class="o">.</span><span class="n">ImageExplanation</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots a detailed LIME explanation with a red-to-green overlay.</span>

<span class="sd">    This function visualizes the output of `explain_with_lime`. It overlays the original</span>
<span class="sd">    image with a heatmap where green areas indicate features that positively contributed</span>
<span class="sd">    to the prediction, and red areas indicate negative contributions.</span>

<span class="sd">    Args:</span>
<span class="sd">        explanation (lime_image.ImageExplanation): The explanation object generated by `explain_with_lime`.</span>
<span class="sd">        image (Image.Image): The original image that was explained.</span>
<span class="sd">        top_k (int, optional): The number of top classes to display explanations for. Defaults to 1.</span>
<span class="sd">        alpha (float, optional): The transparency of the color overlay. Defaults to 0.6.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original Image&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">segments</span> <span class="o">=</span> <span class="n">explanation</span><span class="o">.</span><span class="n">segments</span>

    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">explanation</span><span class="o">.</span><span class="n">top_labels</span><span class="p">[:</span><span class="n">top_k</span><span class="p">]:</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Explanation for Class Index: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

        <span class="n">exp_for_label</span> <span class="o">=</span> <span class="n">explanation</span><span class="o">.</span><span class="n">local_exp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exp_for_label</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No explanation available for class </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">weight_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">segments</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">exp_for_label</span><span class="p">:</span>
            <span class="n">weight_map</span><span class="p">[</span><span class="n">segments</span> <span class="o">==</span> <span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>

        <span class="n">max_abs_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weight_map</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">max_abs_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No significant features found for class </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LIME: No features for class </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">continue</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=-</span><span class="n">max_abs_weight</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_abs_weight</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlGn</span>  <span class="c1"># type: ignore[attr-defined]</span>

        <span class="n">colored_overlay_rgba</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">weight_map</span><span class="p">))</span>
        <span class="n">original_size</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span>
        <span class="n">colored_overlay_resized</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span>
            <span class="n">colored_overlay_rgba</span><span class="p">,</span>
            <span class="p">(</span><span class="n">original_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">original_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">anti_aliasing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">colored_overlay_resized</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>

        <span class="n">sm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Feature Weight (Green: Positive, Red: Negative)&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LIME Explanation for Class Index: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ibbi.plot_shap_explanation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_shap_explanation</span><span class="p">(</span><span class="n">shap_explanation_for_single_image</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">text_prompt</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Plots SHAP explanations for a SINGLE image.</p>
<p>This function is designed to visualize the output of <code>explain_with_shap</code> for one image.
It uses SHAP's built-in image plotting capabilities to show which parts of the image
contributed to the model's predictions for the top-k classes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>shap_explanation_for_single_image</code>
            </td>
            <td>
                  <code><span title="shap.Explanation">Explanation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A SHAP Explanation object for a single image.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="ModelType = TypeVar('ModelType', YOLOSingleClassBeetleDetector, RTDETRSingleClassBeetleDetector, YOLOBeetleMultiClassDetector, RTDETRBeetleMultiClassDetector, GroundingDINOModel, YOLOWorldModel, UntrainedFeatureExtractor, HuggingFaceFeatureExtractor)

  
      module-attribute
   (ibbi.models.ModelType)" href="#ibbi.ModelType">ModelType</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The <code>ibbi</code> model that was explained.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>top_k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of top class explanations to plot. Defaults to 5.</p>
              </div>
            </td>
            <td>
                  <code>5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>text_prompt</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The text prompt used for explaining a zero-shot model. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src\ibbi\explain\shap.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_shap_explanation</span><span class="p">(</span>
    <span class="n">shap_explanation_for_single_image</span><span class="p">:</span> <span class="n">shap</span><span class="o">.</span><span class="n">Explanation</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">ModelType</span><span class="p">,</span>
    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">text_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots SHAP explanations for a SINGLE image.</span>

<span class="sd">    This function is designed to visualize the output of `explain_with_shap` for one image.</span>
<span class="sd">    It uses SHAP&#39;s built-in image plotting capabilities to show which parts of the image</span>
<span class="sd">    contributed to the model&#39;s predictions for the top-k classes.</span>

<span class="sd">    Args:</span>
<span class="sd">        shap_explanation_for_single_image (shap.Explanation): A SHAP Explanation object for a single image.</span>
<span class="sd">        model (ModelType): The `ibbi` model that was explained.</span>
<span class="sd">        top_k (int, optional): The number of top class explanations to plot. Defaults to 5.</span>
<span class="sd">        text_prompt (Optional[str], optional): The text prompt used for explaining a zero-shot model. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Generating Explanations for Image ---&quot;</span><span class="p">)</span>

    <span class="n">image_for_plotting</span> <span class="o">=</span> <span class="n">shap_explanation_for_single_image</span><span class="o">.</span><span class="n">data</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">shap_explanation_for_single_image</span><span class="o">.</span><span class="n">values</span>
    <span class="n">class_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shap_explanation_for_single_image</span><span class="o">.</span><span class="n">output_names</span><span class="p">)</span>

    <span class="n">prediction_fn</span> <span class="o">=</span> <span class="n">_prediction_wrapper</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">text_prompt</span><span class="o">=</span><span class="n">text_prompt</span><span class="p">)</span>
    <span class="n">image_norm</span> <span class="o">=</span> <span class="n">_prepare_image_for_shap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_for_plotting</span><span class="p">))</span>

    <span class="n">prediction_scores</span> <span class="o">=</span> <span class="n">prediction_fn</span><span class="p">(</span><span class="n">image_norm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">top_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">prediction_scores</span><span class="p">)[</span><span class="o">-</span><span class="n">top_k</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">top_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_for_plotting</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Original Image&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">shap_values_for_plot</span> <span class="o">=</span> <span class="n">shap_values</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">top_indices</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
    <span class="n">class_names_for_plot</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">top_indices</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">shap_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️  Warning: SHAP values are all zero. The plot will be empty.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   This can happen if the model&#39;s prediction is not sensitive to the masking.&quot;</span><span class="p">)</span>

    <span class="n">shap</span><span class="o">.</span><span class="n">image_plot</span><span class="p">(</span>
        <span class="n">shap_values</span><span class="o">=</span><span class="p">[</span><span class="n">shap_values_for_plot</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shap_values_for_plot</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">shap_values_for_plot</span><span class="p">,</span>
        <span class="n">pixel_values</span><span class="o">=</span><span class="n">image_for_plotting</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">class_names_for_plot</span><span class="p">]),</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>